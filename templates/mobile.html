<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h2 class="text-2xl font-bold mb-4 text-center">Scan Student QR Code</h2>
        <div id="reader" class="w-full max-w-md mx-auto"></div>
        <div id="student-info" class="hidden mt-4 bg-white p-4 rounded shadow max-w-md mx-auto">
            <img id="student-photo" src="" alt="Student Photo" class="w-32 h-32 object-cover mx-auto rounded">
            <p id="student-name" class="text-center font-semibold mt-2"></p>
            <p id="student-id" class="text-center text-gray-600"></p>
            <div class="flex justify-center space-x-4 mt-4">
                <button id="cancel-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Cancel</button>
                <button id="accept-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Accept</button>
            </div>
        </div>
    </div>
    <script>
        const html5QrCode = new Html5Qrcode("reader");
        const studentInfo = document.getElementById('student-info');
        const studentPhoto = document.getElementById('student-photo');
        const studentName = document.getElementById('student-name');
        const studentId = document.getElementById('student-id');
        const cancelBtn = document.getElementById('cancel-btn');
        const acceptBtn = document.getElementById('accept-btn');
        let currentStudentId = null;

        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText) => {
                fetch(`/get_student/${decodedText}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                            return;
                        }
                        currentStudentId = data.id;
                        studentPhoto.src = `data:image/jpeg;base64,${data.photo}`;
                        studentName.textContent = data.name;
                        studentId.textContent = `ID: ${data.id}`;
                        studentInfo.classList.remove('hidden');
                        html5QrCode.stop();
                    })
                    .catch(err => alert('Error fetching student data'));
            },
            (error) => {
                // Scan error, ignore
            }
        ).catch(err => alert('Error starting QR scanner'));

        cancelBtn.addEventListener('click', () => {
            studentInfo.classList.add('hidden');
            currentStudentId = null;
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    fetch(`/get_student/${decodedText}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert(data.error);
                                return;
                            }
                            currentStudentId = data.id;
                            studentPhoto.src = `data:image/jpeg;base64,${data.photo}`;
                            studentName.textContent = data.name;
                            studentId.textContent = `ID: ${data.id}`;
                            studentInfo.classList.remove('hidden');
                            html5QrCode.stop();
                        });
                }
            );
        });

        acceptBtn.addEventListener('click', () => {
            if (currentStudentId) {
                fetch(`/mark_present/${currentStudentId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Student marked as present');
                            studentInfo.classList.add('hidden');
                            currentStudentId = null;
                            html5QrCode.start(
                                { facingMode: "environment" },
                                { fps: 10, qrbox: { width: 250, height: 250 } },
                                (decodedText) => {
                                    fetch(`/get_student/${decodedText}`)
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.error) {
                                                alert(data.error);
                                                return;
                                            }
                                            currentStudentId = data.id;
                                            studentPhoto.src = `data:image/jpeg;base64,${data.photo}`;
                                            studentName.textContent = data.name;
                                            studentId.textContent = `ID: ${data.id}`;
                                            studentInfo.classList.remove('hidden');
                                            html5QrCode.stop();
                                        });
                                }
                            );
                        } else {
                            alert('Error marking student as present');
                        }
                    });
            }
        });
    </script>
</body>
</html>